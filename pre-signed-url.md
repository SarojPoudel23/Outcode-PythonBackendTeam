# Securing File Access in AWS S3 with Presigned URLs

## Introduction

AWS S3 provides a mechanism called presigned URLs, enabling temporary access to specific objects for users without direct AWS credentials. This feature facilitates secure sharing of S3 resources without compromising security.

## Understanding Presigned URLs

Presigned URLs are generated by S3 bucket owners to grant temporary access to specific objects. Users with these URLs can perform predefined actions on corresponding S3 objects, such as downloading or uploading files, for a limited time.

## Key Steps

1. **Prerequisites:**
   - AWS account credentials
   - Django project setup
   - Python 3.6 or later installed
   - Installation of the boto3 library
   - IAM user access keys and secret keys

2. **Configuration:**
   - Install the boto3 library using `pip install boto3`.
   - Configure the boto3 client with AWS access keys and secret keys to interact with AWS S3.

3. **URL Generation:**
   - Define a new URL endpoint in your Django project to generate presigned URLs.
   - Implement a Django view to handle presigned URL requests, leveraging the boto3 library to generate URLs for S3 objects.

4. **Presigned URL Generation Function:**
   - Create a function within your Django project to generate presigned URLs for S3 bucket objects.
   - This function should utilize the boto3 client to generate the presigned URL for the specified S3 object.

## Example of Generated Presigned URL

```json
{
    "presigned_url": "https://example-bucket.s3.amazonaws.com/documents/report.pdf?AWSAccessKeyId=AKIA3EXAMPLE4YUNW&Signature=%2FD82n3a%2BEx4mpleSig%2Bmple%3D&Expires=1885300800"
}
```

**Explanation:**
  - The presigned URL grants temporary access to the S3 object located at documents/report.pdf in the example-bucket.
  - Query parameters include AWSAccessKeyId, Signature, and Expires, used for authentication, authorization, and setting URL expiration, respectively.
  - Recipients can utilize this URL to access the specified S3 object without requiring AWS credentials or permissions.

## Step-by-Step Guide:

1. Install `boto3` library:

```bash
pip install boto3
```

2. Configure Boto3 Client for S3 Bucket:

- Set up configuration settings for the boto3 client to interact with the S3 bucket. Replace `AWS_ACCESS_KEY_ID` and `AWS_SECRET_ACCESS_KEY` with your AWS IAM user access keys and secret keys.

```python
import boto3

AWS_ACCESS_KEY_ID = "YOUR_AWS_ACCESS_KEY_ID"
AWS_SECRET_ACCESS_KEY = "YOUR_AWS_SECRET_ACCESS_KEY"

s3_client = boto3.client(
    "s3",
    aws_access_key_id=AWS_ACCESS_KEY_ID,
    aws_secret_access_key=AWS_SECRET_ACCESS_KEY
)

```


3. Create a Django URL for Presigned URLs:
   
- Define a new Django URL to generate presigned URLs for S3 bucket objects.

```python
path('presigned-url', PresignedView.as_view(), name='presigned-url'),
```

4. Implement a Django View for Presigned URLs:

- Create a Django view to handle requests for generating presigned URLs for S3 bucket objects.

```python
from rest_framework.views import APIView
from rest_framework.response import Response
from rest_framework import status

class PresignedView(APIView):
    def get(self, request, *args, **kwargs):
        file_name = request.query_params.get("file_name")

        try:
            presigned_url = generate_presigned_url(file_name)

            if presigned_url:
                return Response(
                    {"presigned_url": presigned_url},
                    status=status.HTTP_200_OK,
                )
            else:
                return Response(
                    {"message": "Failed to generate presigned URL"},
                    status=status.HTTP_400_BAD_REQUEST,
                )

        except Exception as e:
            logger.critical(f"Error generating presigned URL: {str(e)}")

            return Response(
                {"message": "Failed to generate presigned URL"},
                status=status.HTTP_400_BAD_REQUEST,
            )

```


5. Define a Function to Generate Presigned URLs:

- Create a function to generate presigned URLs for S3 bucket objects.

```python
from django.conf import settings
from config.boto3 import s3

def generate_presigned_url(
    file_name,  # File name or key in S3 bucket
    bucket_name=settings.AWS_STORAGE_BUCKET_NAME,   # S3 bucket name
    expires_in=settings.AWS_PRESIGNED_URL_EXPIRATION_TIME,  # Expiration time in seconds
):
    """
    Generate presigned URL
    """
    try:
        presigned_url = s3.generate_presigned_url(
            "get_object",
            Params={
                "Bucket": bucket_name,
                "Key": file_name,
            },
            ExpiresIn=expires_in,
        )

        return presigned_url

    except Exception as e:
        logger.critical(f"Error generating presigned URL: {str(e)}")

        return None

```

## Conclusion
- Presigned URLs offer a secure method for granting temporary access to AWS S3 objects, enhancing flexibility in file-sharing workflows. By following the outlined steps, users can seamlessly implement this feature within their Django projects, ensuring robust security measures.
